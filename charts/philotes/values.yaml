# Default values for Philotes umbrella chart
# This is a YAML-formatted file.

# Global settings shared across all sub-charts
global:
  # Image pull secrets for all charts
  imagePullSecrets: []
  # Storage class for persistent volumes
  storageClass: ""

# ============================================================
# Vault Configuration (shared by API and Worker)
# ============================================================
vault:
  # Enable Vault integration
  enabled: false
  # Vault server address
  address: ""
  # Vault namespace (Enterprise feature, leave empty for OSS)
  namespace: ""
  # Authentication method: "kubernetes" or "token"
  authMethod: "kubernetes"
  # Vault role for Kubernetes auth
  role: "philotes"
  # Path to Kubernetes service account token
  tokenPath: "/var/run/secrets/kubernetes.io/serviceaccount/token"
  # Static token (for development only, use authMethod: "token")
  token: ""
  # Skip TLS verification (not recommended for production)
  tlsSkipVerify: "false"
  # CA certificate path for Vault TLS
  caCert: ""
  # Secret mount path in Vault
  secretMountPath: "secret"
  # Token renewal interval (matches config.go default)
  tokenRenewalInterval: "1h"
  # Secret refresh interval (matches config.go default)
  secretRefreshInterval: "5m"
  # Fall back to environment variables if Vault is unavailable
  fallbackToEnv: "true"
  # Secret paths in Vault
  secretPaths:
    # Path to buffer database credentials
    databaseBuffer: "philotes/database/buffer"
    # Path to source database credentials
    databaseSource: "philotes/database/source"
    # Path to MinIO/S3 storage credentials
    storageMinio: "philotes/storage/minio"

# ============================================================
# Philotes API Configuration
# ============================================================
api:
  enabled: true

  replicaCount: 1

  image:
    repository: ghcr.io/janovincze/philotes-api
    tag: ""

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  ingress:
    enabled: false

  autoscaling:
    enabled: false

  pdb:
    enabled: true

  networkPolicy:
    enabled: false

  database:
    host: "philotes-postgresql"
    port: "5432"
    name: "philotes"
    user: "philotes"
    existingSecret: "philotes-postgresql"

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  alerting:
    enabled: true
    prometheusUrl: "http://prometheus:9090"

  # Vault configuration (inherits from top-level vault if not specified)
  vault: {}

# ============================================================
# Philotes Worker Configuration
# ============================================================
worker:
  enabled: true

  replicaCount: 1

  image:
    repository: ghcr.io/janovincze/philotes-worker
    tag: ""

  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 256Mi

  # KEDA autoscaling configuration
  keda:
    enabled: false
    minReplicas: 1
    maxReplicas: 10
    pollingInterval: 30
    cooldownPeriod: 300
    # Scale to zero support (set idleReplicaCount to 0 to enable; null = disabled)
    idleReplicaCount: null  # null = disabled
    minReplicaCount: 1
    # Prometheus-based scaling (recommended)
    prometheus:
      enabled: true
      serverAddress: "http://prometheus:9090"
      lagTrigger:
        enabled: true
        metricName: philotes_cdc_lag_seconds
        query: "max(philotes_cdc_lag_seconds)"
        threshold: "300"
        activationThreshold: "60"
      bufferTrigger:
        enabled: true
        metricName: philotes_buffer_depth
        query: "max(philotes_buffer_depth)"
        threshold: "8000"
        activationThreshold: "1000"
      throughputTrigger:
        enabled: false
        metricName: philotes_buffer_events_processed_total
        query: "sum(rate(philotes_buffer_events_processed_total[5m]))"
        threshold: "1000"
    # PostgreSQL-based scaling (alternative)
    postgresql:
      enabled: false
      host: ""
      port: "5432"
      database: ""
      user: ""
      password: ""
      existingSecret: ""
      passwordKey: "password"
      sslMode: "disable"
      query: "SELECT COALESCE(pg_wal_lsn_diff(pg_current_wal_lsn(), confirmed_flush_lsn), 0) FROM pg_replication_slots WHERE slot_name = 'philotes_cdc'"
      targetQueryValue: "1000000"
      activationTargetQueryValue: "100000"
    # CPU/Memory fallback
    cpu:
      enabled: false
      metricType: "Utilization"
      value: "80"
    memory:
      enabled: false
      metricType: "Utilization"
      value: "80"

  # Standard HPA autoscaling (fallback for non-KEDA environments)
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  pdb:
    enabled: true

  networkPolicy:
    enabled: false

  # Source database (must be configured for your environment)
  source:
    host: ""
    port: "5432"
    database: ""
    user: ""
    existingSecret: ""

  database:
    host: "philotes-postgresql"
    port: "5432"
    name: "philotes"
    user: "philotes"
    existingSecret: "philotes-postgresql"

  storage:
    endpoint: "philotes-minio:9000"
    bucket: "philotes"
    existingSecret: "philotes-minio"

  iceberg:
    catalogUrl: "http://philotes-lakekeeper:8181"
    warehouse: "philotes"

  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

  # Vault configuration (inherits from top-level vault if not specified)
  vault: {}

# ============================================================
# Lakekeeper (Iceberg Catalog) Configuration
# ============================================================
lakekeeper:
  enabled: true

  replicaCount: 1

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  database:
    host: "philotes-postgresql"
    port: "5432"
    name: "philotes"
    schema: "lakekeeper"
    user: "philotes"
    existingSecret: "philotes-postgresql"

  config:
    authz:
      enabled: false
    openid:
      enabled: false

# ============================================================
# PostgreSQL Configuration (Bitnami chart)
# ============================================================
postgresql:
  enabled: true

  auth:
    username: philotes
    password: philotes
    database: philotes

  primary:
    persistence:
      enabled: true
      size: 10Gi

    # Enable logical replication for CDC
    extendedConfiguration: |
      wal_level = logical
      max_replication_slots = 10
      max_wal_senders = 10

  # Initialize Philotes schema
  primary:
    initdb:
      scriptsConfigMap: ""

# ============================================================
# MinIO Configuration (MinIO chart)
# ============================================================
minio:
  enabled: true

  mode: standalone

  rootUser: minioadmin
  rootPassword: minioadmin

  persistence:
    enabled: true
    size: 50Gi

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Create default bucket
  buckets:
    - name: philotes
      policy: none
      purge: false

  # Console access
  consoleIngress:
    enabled: false
